<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geez Bingo - Card Selection</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .wallet-info {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            color: white;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .wallet-amount {
            font-size: 28px;
            font-weight: bold;
            margin: 10px 0;
        }

        .card-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .card-number {
            background: white;
            border-radius: 10px;
            padding: 15px 5px;
            text-align: center;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            font-size: 14px;
        }

        .card-number:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .card-number.selected {
            border-color: #4CAF50;
            background: #E8F5E8;
        }

        .card-number.unavailable {
            background: #f0f0f0;
            color: #999;
            cursor: not-allowed;
        }

        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .page-btn {
            background: white;
            border: none;
            padding: 10px 15px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .page-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .page-info {
            color: white;
            font-weight: bold;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-secondary {
            background: white;
            color: #333;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .bingo-card {
            background: white;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .bingo-card.show {
            display: block;
        }

        .bingo-header {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            text-align: center;
            font-weight: bold;
            margin-bottom: 10px;
            background: #333;
            color: white;
            border-radius: 5px;
            padding: 5px;
        }

        .bingo-row {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            text-align: center;
            margin-bottom: 5px;
        }

        .bingo-cell {
            padding: 10px 5px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin: 2px;
            font-size: 12px;
        }

        .bingo-cell.free {
            background: #4CAF50;
            color: white;
            font-weight: bold;
        }

        .bingo-cell.marked {
            background: #FFEB3B;
            font-weight: bold;
        }

        .loading {
            text-align: center;
            color: white;
            padding: 20px;
            font-size: 16px;
        }

        .search-box {
            margin-bottom: 15px;
        }

        .search-input {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .status-info {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            text-align: center;
        }

        .success-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #4CAF50;
            color: white;
            padding: 20px 30px;
            border-radius: 10px;
            z-index: 1000;
            text-align: center;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.3);
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .pulse {
            animation: pulse 0.5s ease-in-out;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Geez Bingo</h1>
            <p>Select Your Bingo Card</p>
        </div>

        <div class="wallet-info">
            <div>Your Wallet Balance</div>
            <div class="wallet-amount" id="walletAmount">0</div>
            <div>Stake: <span id="stakeAmount">10</span> coins</div>
        </div>

        <div class="status-info" id="statusInfo">
            <div>Loading game data...</div>
        </div>

        <div class="search-box">
            <input type="number" class="search-input" id="cardSearch" placeholder="Enter card number (145-544)" min="145" max="544">
        </div>

        <div class="pagination">
            <button class="page-btn" id="prevPage">‚¨ÖÔ∏è Previous</button>
            <span class="page-info" id="pageInfo">Page 1/10</span>
            <button class="page-btn" id="nextPage">Next ‚û°Ô∏è</button>
        </div>

        <div class="card-grid" id="cardGrid">
            <!-- Cards will be dynamically inserted here -->
        </div>

        <div class="action-buttons">
            <button class="btn btn-secondary" id="randomCard">üé≤ Random Card</button>
            <button class="btn btn-primary" id="selectCard" disabled>‚úÖ Select Card</button>
        </div>

        <div class="bingo-card" id="bingoCardPreview">
            <h3 style="text-align: center; margin-bottom: 15px;">üé´ Card Preview</h3>
            <div class="bingo-header">
                <div>B</div>
                <div>I</div>
                <div>N</div>
                <div>G</div>
                <div>O</div>
            </div>
            <!-- Bingo card rows will be dynamically inserted here -->
        </div>

        <div class="loading" id="loading">
            Loading available cards...
        </div>
    </div>

    // Replace the entire script section with this enhanced version

<script>
    class BingoWebApp {
        constructor() {
            this.tg = window.Telegram.WebApp;
            this.selectedCard = null;
            this.currentPage = 0;
            this.cardsPerPage = 40;
            this.availableCards = [];
            this.userData = {};
            this.gameData = {};
            this.isInitialized = false;
            this.ws = null;
            this.apiUrl = 'https://your-backend-url.com'; // Replace with your backend URL

            this.init();
        }

        async init() {
            try {
                this.tg.expand();
                this.tg.ready();

                // Initialize user
                await this.initializeUser();
                
                // Load game data
                await this.loadGameData();
                
                // Connect to WebSocket for real-time updates
                this.connectWebSocket();
                
                this.setupEventListeners();
                this.isInitialized = true;
                
            } catch (error) {
                console.error('Initialization error:', error);
                this.showError('Failed to initialize. Please try again.');
            }
        }

        async initializeUser() {
            const user = this.tg.initDataUnsafe?.user;
            if (!user) {
                throw new Error('User data not available');
            }

            // Register user with backend
            const response = await fetch(`${this.apiUrl}/api/users`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    telegram_id: user.id,
                    username: user.first_name
                })
            });

            if (!response.ok) {
                throw new Error('Failed to register user');
            }

            this.userData = await response.json();
        }

        async loadGameData() {
            try {
                this.showLoading('Loading game data...');
                
                // Fetch current game
                const gameResponse = await fetch(`${this.apiUrl}/api/games/current`);
                if (!gameResponse.ok) throw new Error('Failed to fetch game');
                this.gameData = await gameResponse.json();

                // Fetch available cards
                const cardsResponse = await fetch(`${this.apiUrl}/api/available-cards/${this.gameData.id}`);
                if (cardsResponse.ok) {
                    const cardsData = await cardsResponse.json();
                    this.availableCards = cardsData.available_cards;
                }

                this.hideLoading();
                this.renderCardGrid();
                this.updateWalletDisplay();
                this.updateStatusInfo();
                
            } catch (error) {
                console.error('Error loading game data:', error);
                this.showError('Error loading game data. Please try again.');
            }
        }

        connectWebSocket() {
            try {
                this.ws = new WebSocket(`wss://your-backend-url.com/ws/${this.userData.id}`);
                
                this.ws.onopen = () => {
                    console.log('WebSocket connected');
                };

                this.ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    this.handleWebSocketMessage(data);
                };

                this.ws.onclose = () => {
                    console.log('WebSocket disconnected');
                    // Attempt to reconnect after 5 seconds
                    setTimeout(() => this.connectWebSocket(), 5000);
                };

            } catch (error) {
                console.error('WebSocket connection failed:', error);
            }
        }

        handleWebSocketMessage(data) {
            switch (data.type) {
                case 'player_joined':
                    this.updateStatusInfo();
                    this.showMessage(`New player joined! Total: ${data.player_count}`);
                    break;
                
                case 'game_started':
                    this.showMessage('üéÆ Game started! Numbers will be called automatically.');
                    break;
                
                case 'number_called':
                    this.showMessage(`üé≤ Number called: ${data.number}`);
                    break;
                
                case 'winner':
                    this.showMessage(`üèÜ ${data.winner} won ${data.pot_amount} coins with card #${data.card_number}!`);
                    break;
            }
        }

        // ... (rest of the methods remain similar but use the API)

        async confirmCardSelection() {
            if (!this.selectedCard) return;

            if (this.userData.wallet < this.gameData.entry_fee) {
                this.showMessage('Insufficient funds in your wallet!');
                return;
            }

            try {
                this.showLoading('Processing selection...');

                const response = await fetch(`${this.apiUrl}/api/games/${this.gameData.id}/join`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: this.userData.id,
                        card_number: this.selectedCard
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Join failed');
                }

                const result = await response.json();

                this.showSuccess(`Card #${this.selectedCard} selected successfully!`);

                // Send confirmation to Telegram bot
                if (this.tg.sendData) {
                    this.tg.sendData(JSON.stringify({
                        action: 'select_card',
                        card_number: this.selectedCard,
                        success: true
                    }));
                }

                setTimeout(() => {
                    if (this.tg.close) {
                        this.tg.close();
                    }
                }, 2000);

            } catch (error) {
                console.error('Error selecting card:', error);
                this.showError(error.message || 'Error selecting card. Please try again.');
            }
        }

        // ... (other methods remain similar)
    }

    // Initialize the app
    document.addEventListener('DOMContentLoaded', () => {
        new BingoWebApp();
    });
</script>
</body>
</html>
