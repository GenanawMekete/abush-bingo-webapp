<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geez Bingo - Card Selection</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .wallet-info {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            color: white;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .wallet-amount {
            font-size: 28px;
            font-weight: bold;
            margin: 10px 0;
        }

        .card-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .card-number {
            background: white;
            border-radius: 10px;
            padding: 15px 5px;
            text-align: center;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            font-size: 14px;
        }

        .card-number:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .card-number.selected {
            border-color: #4CAF50;
            background: #E8F5E8;
        }

        .card-number.unavailable {
            background: #f0f0f0;
            color: #999;
            cursor: not-allowed;
        }

        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .page-btn {
            background: white;
            border: none;
            padding: 10px 15px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .page-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .page-info {
            color: white;
            font-weight: bold;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-secondary {
            background: white;
            color: #333;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .bingo-card {
            background: white;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .bingo-card.show {
            display: block;
        }

        .bingo-header {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            text-align: center;
            font-weight: bold;
            margin-bottom: 10px;
            background: #333;
            color: white;
            border-radius: 5px;
            padding: 5px;
        }

        .bingo-row {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            text-align: center;
            margin-bottom: 5px;
        }

        .bingo-cell {
            padding: 10px 5px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin: 2px;
            font-size: 12px;
        }

        .bingo-cell.free {
            background: #4CAF50;
            color: white;
            font-weight: bold;
        }

        .bingo-cell.marked {
            background: #FFEB3B;
            font-weight: bold;
        }

        .loading {
            text-align: center;
            color: white;
            padding: 20px;
            font-size: 16px;
        }

        .search-box {
            margin-bottom: 15px;
        }

        .search-input {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .status-info {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            text-align: center;
        }

        .success-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #4CAF50;
            color: white;
            padding: 20px 30px;
            border-radius: 10px;
            z-index: 1000;
            text-align: center;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.3);
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .pulse {
            animation: pulse 0.5s ease-in-out;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Geez Bingo</h1>
            <p>Select Your Bingo Card</p>
        </div>

        <div class="wallet-info">
            <div>Your Wallet Balance</div>
            <div class="wallet-amount" id="walletAmount">0</div>
            <div>Stake: <span id="stakeAmount">10</span> coins</div>
        </div>

        <div class="status-info" id="statusInfo">
            <div>Loading game data...</div>
        </div>

        <div class="search-box">
            <input type="number" class="search-input" id="cardSearch" placeholder="Enter card number (145-544)" min="145" max="544">
        </div>

        <div class="pagination">
            <button class="page-btn" id="prevPage">‚¨ÖÔ∏è Previous</button>
            <span class="page-info" id="pageInfo">Page 1/10</span>
            <button class="page-btn" id="nextPage">Next ‚û°Ô∏è</button>
        </div>

        <div class="card-grid" id="cardGrid">
            <!-- Cards will be dynamically inserted here -->
        </div>

        <div class="action-buttons">
            <button class="btn btn-secondary" id="randomCard">üé≤ Random Card</button>
            <button class="btn btn-primary" id="selectCard" disabled>‚úÖ Select Card</button>
        </div>

        <div class="bingo-card" id="bingoCardPreview">
            <h3 style="text-align: center; margin-bottom: 15px;">üé´ Card Preview</h3>
            <div class="bingo-header">
                <div>B</div>
                <div>I</div>
                <div>N</div>
                <div>G</div>
                <div>O</div>
            </div>
            <!-- Bingo card rows will be dynamically inserted here -->
        </div>

        <div class="loading" id="loading">
            Loading available cards...
        </div>
    </div>

    <script>
        class BingoWebApp {
            constructor() {
                this.tg = window.Telegram.WebApp;
                this.selectedCard = null;
                this.currentPage = 0;
                this.cardsPerPage = 40;
                this.availableCards = [];
                this.userData = {};
                this.gameData = {};
                this.isInitialized = false;

                this.init();
            }

            async init() {
                try {
                    // Initialize Telegram Web App
                    this.tg.expand();
                    this.tg.enableClosingConfirmation();
                    this.tg.ready();

                    console.log('Telegram Web App initialized');

                    // Load initial data
                    await this.loadGameData();
                    this.setupEventListeners();
                    this.isInitialized = true;
                    
                } catch (error) {
                    console.error('Initialization error:', error);
                    this.showError('Failed to initialize. Please try again.');
                }
            }

            async loadGameData() {
                try {
                    this.showLoading('Loading game data...');
                    
                    // Simulate API call - in production this would fetch from your bot
                    await this.simulateGameData();
                    
                    this.hideLoading();
                    this.renderCardGrid();
                    this.updateWalletDisplay();
                    this.updateStatusInfo();
                    
                } catch (error) {
                    console.error('Error loading game data:', error);
                    this.showError('Error loading game data. Please try again.');
                }
            }

            async simulateGameData() {
                // Simulate API call delay
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Generate simulated data
                const allCards = Array.from({length: 400}, (_, i) => i + 145);
                const availableCards = allCards.filter(() => Math.random() > 0.4); // 60% available
                
                this.gameData = {
                    wallet: 162,
                    stake: 10,
                    availableCards: availableCards,
                    currentGame: {
                        active: false,
                        pot: 350,
                        players: 12
                    },
                    winPattern: "Line"
                };

                this.availableCards = availableCards;
            }

            setupEventListeners() {
                // Pagination
                document.getElementById('prevPage').addEventListener('click', () => this.previousPage());
                document.getElementById('nextPage').addEventListener('click', () => this.nextPage());

                // Card selection
                document.getElementById('randomCard').addEventListener('click', () => this.selectRandomCard());
                document.getElementById('selectCard').addEventListener('click', () => this.confirmCardSelection());

                // Search
                document.getElementById('cardSearch').addEventListener('input', (e) => this.handleSearch(e));
                document.getElementById('cardSearch').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.handleSearchEnter(e);
                    }
                });

                // Handle visibility changes (when app is reopened)
                document.addEventListener('visibilitychange', () => {
                    if (!document.hidden && this.isInitialized) {
                        this.refreshData();
                    }
                });
            }

            renderCardGrid() {
                const grid = document.getElementById('cardGrid');
                grid.innerHTML = '';

                const startCard = 145 + (this.currentPage * this.cardsPerPage);
                const endCard = Math.min(startCard + this.cardsPerPage - 1, 544);

                for (let cardNum = startCard; cardNum <= endCard; cardNum++) {
                    const cardElement = document.createElement('div');
                    cardElement.className = 'card-number';
                    cardElement.textContent = cardNum;
                    cardElement.dataset.cardNumber = cardNum;

                    if (!this.availableCards.includes(cardNum)) {
                        cardElement.classList.add('unavailable');
                    } else {
                        cardElement.addEventListener('click', () => this.selectCard(cardNum));
                    }

                    grid.appendChild(cardElement);
                }

                this.updatePagination();
            }

            selectCard(cardNumber) {
                if (!this.availableCards.includes(cardNumber)) {
                    return;
                }

                // Deselect previous card
                document.querySelectorAll('.card-number.selected').forEach(card => {
                    card.classList.remove('selected');
                });

                // Select new card
                const cardElement = document.querySelector(`[data-card-number="${cardNumber}"]`);
                if (cardElement) {
                    cardElement.classList.add('selected');
                    cardElement.classList.add('pulse');
                    setTimeout(() => cardElement.classList.remove('pulse'), 500);
                }

                this.selectedCard = cardNumber;
                document.getElementById('selectCard').disabled = false;

                // Show card preview
                this.showCardPreview(cardNumber);
            }

            selectRandomCard() {
                const availableOnPage = this.availableCards.filter(card => 
                    card >= 145 + (this.currentPage * this.cardsPerPage) && 
                    card < 145 + ((this.currentPage + 1) * this.cardsPerPage)
                );

                if (availableOnPage.length > 0) {
                    const randomCard = availableOnPage[Math.floor(Math.random() * availableOnPage.length)];
                    this.selectCard(randomCard);
                } else {
                    this.showMessage('No available cards on this page. Try another page.');
                }
            }

            async confirmCardSelection() {
                if (!this.selectedCard) return;

                if (this.gameData.wallet < this.gameData.stake) {
                    this.showMessage('Insufficient funds in your wallet!');
                    return;
                }

                try {
                    this.showLoading('Processing selection...');

                    // Prepare data to send back to bot
                    const selectionData = {
                        action: 'select_card',
                        card_number: this.selectedCard,
                        user_id: this.tg.initDataUnsafe?.user?.id,
                        timestamp: Date.now()
                    };

                    console.log('Sending selection data:', selectionData);

                    // Send data to Telegram bot
                    if (this.tg.sendData) {
                        this.tg.sendData(JSON.stringify(selectionData));
                    }

                    // Show success message
                    this.showSuccess(`Card #${this.selectedCard} selected successfully!`);

                    // Close the web app after a delay
                    setTimeout(() => {
                        if (this.tg.close) {
                            this.tg.close();
                        }
                    }, 2000);

                } catch (error) {
                    console.error('Error selecting card:', error);
                    this.showError('Error selecting card. Please try again.');
                }
            }

            showCardPreview(cardNumber) {
                const preview = document.getElementById('bingoCardPreview');
                preview.classList.add('show');

                // Generate bingo card based on card number (deterministic)
                const card = this.generateBingoCard(cardNumber);
                this.renderBingoCard(card);
            }

            generateBingoCard(seed) {
                // Use seed to generate deterministic card
                const rng = this.seededRandom(seed);
                const card = { B: [], I: [], N: [], G: [], O: [] };
                const ranges = {
                    'B': [1, 15],
                    'I': [16, 30],
                    'N': [31, 45],
                    'G': [46, 60],
                    'O': [61, 75]
                };

                for (const [letter, [min, max]] of Object.entries(ranges)) {
                    const numbers = [];
                    while (numbers.length < 5) {
                        const num = Math.floor(rng() * (max - min + 1)) + min;
                        if (!numbers.includes(num)) {
                            numbers.push(num);
                        }
                    }
                    card[letter] = numbers.sort((a, b) => a - b);
                }

                // Center is free
                card['N'][2] = 'FREE';

                return card;
            }

            seededRandom(seed) {
                let value = seed;
                return function() {
                    value = (value * 9301 + 49297) % 233280;
                    return value / 233280;
                };
            }

            renderBingoCard(card) {
                const container = document.getElementById('bingoCardPreview');
                // Clear existing content except the header
                const header = container.querySelector('.bingo-header');
                container.innerHTML = '';
                if (header) container.appendChild(header);
                
                let html = '';

                for (let i = 0; i < 5; i++) {
                    html += '<div class="bingo-row">';
                    for (const letter of ['B', 'I', 'N', 'G', 'O']) {
                        const value = card[letter][i];
                        const cellClass = value === 'FREE' ? 'bingo-cell free' : 'bingo-cell';
                        html += `<div class="${cellClass}">${value}</div>`;
                    }
                    html += '</div>';
                }

                container.innerHTML += html;
            }

            previousPage() {
                if (this.currentPage > 0) {
                    this.currentPage--;
                    this.renderCardGrid();
                }
            }

            nextPage() {
                const totalPages = Math.ceil(400 / this.cardsPerPage);
                if (this.currentPage < totalPages - 1) {
                    this.currentPage++;
                    this.renderCardGrid();
                }
            }

            updatePagination() {
                const totalPages = Math.ceil(400 / this.cardsPerPage);
                document.getElementById('pageInfo').textContent = `Page ${this.currentPage + 1}/${totalPages}`;
                document.getElementById('prevPage').disabled = this.currentPage === 0;
                document.getElementById('nextPage').disabled = this.currentPage >= totalPages - 1;
            }

            handleSearch(e) {
                const searchTerm = e.target.value.trim();
                if (searchTerm) {
                    const cardNum = parseInt(searchTerm);
                    if (cardNum >= 145 && cardNum <= 544) {
                        // Find which page this card would be on
                        const page = Math.floor((cardNum - 145) / this.cardsPerPage);
                        if (page !== this.currentPage) {
                            this.currentPage = page;
                            this.renderCardGrid();
                        }
                        
                        // Highlight the card
                        const cardElement = document.querySelector(`[data-card-number="${cardNum}"]`);
                        if (cardElement) {
                            cardElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            cardElement.style.boxShadow = '0 0 0 3px #4CAF50';
                            setTimeout(() => {
                                cardElement.style.boxShadow = '';
                            }, 2000);
                        }
                    }
                }
            }

            handleSearchEnter(e) {
                const searchTerm = e.target.value.trim();
                if (searchTerm) {
                    const cardNum = parseInt(searchTerm);
                    if (cardNum >= 145 && cardNum <= 544 && this.availableCards.includes(cardNum)) {
                        this.selectCard(cardNum);
                    } else {
                        this.showMessage('Card not available. Please select another card.');
                    }
                }
            }

            updateWalletDisplay() {
                document.getElementById('walletAmount').textContent = this.gameData.wallet;
                document.getElementById('stakeAmount').textContent = this.gameData.stake;
            }

            updateStatusInfo() {
                const statusElement = document.getElementById('statusInfo');
                statusElement.innerHTML = `
                    <div><strong>Available Cards:</strong> ${this.availableCards.length}/400</div>
                    <div><strong>Current Pot:</strong> ${this.gameData.currentGame.pot} coins</div>
                    <div><strong>Win Pattern:</strong> ${this.gameData.winPattern}</div>
                    <div><strong>Players:</strong> ${this.gameData.currentGame.players}</div>
                `;
            }

            showLoading(message) {
                const loading = document.getElementById('loading');
                loading.textContent = message;
                loading.style.display = 'block';
                
                document.getElementById('cardGrid').style.display = 'none';
                document.getElementById('bingoCardPreview').style.display = 'none';
                document.getElementById('statusInfo').style.display = 'none';
            }

            hideLoading() {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('cardGrid').style.display = 'grid';
                document.getElementById('bingoCardPreview').style.display = 'block';
                document.getElementById('statusInfo').style.display = 'block';
            }

            showSuccess(message) {
                this.showMessage(message, 'success');
            }

            showError(message) {
                this.showMessage(message, 'error');
            }

            showMessage(message, type = 'info') {
                const messageDiv = document.createElement('div');
                messageDiv.className = `success-message ${type}`;
                messageDiv.textContent = message;
                messageDiv.style.background = type === 'error' ? '#f44336' : type === 'success' ? '#4CAF50' : '#2196F3';
                
                document.body.appendChild(messageDiv);

                setTimeout(() => {
                    if (document.body.contains(messageDiv)) {
                        document.body.removeChild(messageDiv);
                    }
                }, 3000);
            }

            refreshData() {
                console.log('Refreshing game data...');
                this.loadGameData();
            }
        }

        // Initialize the web app when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            // Check if we're in Telegram Web App
            if (window.Telegram && window.Telegram.WebApp) {
                new BingoWebApp();
            } else {
                // Fallback for testing outside Telegram
                console.log('Running in standalone mode');
                // Mock Telegram Web App environment for testing
                window.Telegram = {
                    WebApp: {
                        initData: '',
                        initDataUnsafe: {},
                        version: '6.0',
                        platform: 'web',
                        expand: () => console.log('App expanded'),
                        ready: () => console.log('App ready'),
                        enableClosingConfirmation: () => console.log('Closing confirmation enabled'),
                        sendData: (data) => {
                            console.log('Data sent to bot:', data);
                            alert('Card selection sent to bot! In Telegram, this would close the app.');
                        },
                        close: () => {
                            console.log('App closed');
                            alert('App would close in Telegram environment');
                        }
                    }
                };
                
                new BingoWebApp();
            }
        });

        // Add CSS for standalone testing
        if (!window.Telegram || !window.Telegram.WebApp) {
            const style = document.createElement('style');
            style.textContent = `
                body::before {
                    content: "‚ö†Ô∏è Testing Mode - Outside Telegram";
                    display: block;
                    background: #ff9800;
                    color: white;
                    padding: 10px;
                    text-align: center;
                    font-weight: bold;
                    margin-bottom: 20px;
                }
            `;
            document.head.appendChild(style);
        }
    </script>
</body>
</html>
